<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WS Server Console</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: ui-monospace, Menlo, Consolas, monospace; margin: 0; background: #0b0b0b; color: #c8facc; }
    header { padding: 10px 14px; background: #111; border-bottom: 1px solid #222; }
    main { padding: 10px 14px; }
    pre { white-space: pre-wrap; word-break: break-word; }
    .log-controls { position: sticky; top: 0; background: #111; padding: 0.5rem 0; z-index: 10; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    input, select, button { padding: 0.5rem; border: 1px solid #ccc; border-radius: 5px; background: #fff; color: #000; }
    @media (prefers-color-scheme: dark) {
      input, select, button { background: #444; color: #fff; }
    }
    select { width: 200px; }
    #searchLogs { max-width: 150px; }
  </style>
</head>
<body>
  <header>
    <strong>Server Console</strong> â€” live from /logs (SSE)
    <span style="opacity: 0.7"> | <a href="/" style="color: #9cf">tester</a></span>
  </header>
  <main>
    <div class="log-controls">
      <button id="copyLogs">Copy Logs</button>
      <button id="downloadLogs">Download Logs</button>
      <button id="pauseLogs">Pause Logs</button>
      <input id="searchLogs" placeholder="Search logs..."/>
      <select id="logFilter">
        <option value="all">All Logs</option>
        <option value="ping">Ping</option>
        <option value="pong">Pong</option>
        <option value="file-transfers">File Transfers</option>
        <option value="errors">Errors</option>
        <option value="connections">Connection Events</option>
        <option value="messages">Messages</option>
      </select>
    </div>
    <pre id="out"></pre>
  </main>
  <script>
    (function() {
      const out = document.getElementById('out');
      const copyLogsBtn = document.getElementById('copyLogs');
      const downloadLogsBtn = document.getElementById('downloadLogs');
      const pauseLogsBtn = document.getElementById('pauseLogs');
      const searchLogs = document.getElementById('searchLogs');
      const logFilter = document.getElementById('logFilter');
      let logLines = [], isPaused = false;
      const MAX_LOG_LINES = 5000; // Increased for longer history
      const debounce = (fn, delay) => {
        let timeout;
        return (...args) => {
          if (timeout) clearTimeout(timeout);
          timeout = setTimeout(() => {
            fn(...args);
            timeout = null;
          }, delay);
        };
      };
      const log = (m) => {
        const s = new Date().toISOString() + ' [CONSOLE] ' + m;
        console.log(s);
        logLines.push(s);
        if (logLines.length > MAX_LOG_LINES) logLines.shift();
        updateLogDisplay();
      };
      const updateLogDisplay = debounce(() => {
        if (isPaused) return;
        const searchTerm = searchLogs.value.toLowerCase();
        const selectedFilter = logFilter.value;
        const filteredLogs = logLines.filter(line => {
          const isPing = line.includes('PING');
          const isPong = line.includes('PONG');
          const isFileTransfer = line.includes('FILE CHUNK') || line.includes('FILE META') || line.includes('FILE END') || 
                                line.includes('UPLOAD COMPLETE') || line.includes('DELETE COMPLETE') || line.includes('Unzip file error');
          const isError = line.includes('ERROR') || line.includes('failed') || line.includes('mismatch');
          const isConnection = line.includes('OPEN') || line.includes('CLOSE') || line.includes('ERROR') || line.includes('WELCOME');
          const isMessage = line.includes('SAY') || line.includes('MSG');
          if (selectedFilter === 'all') return searchTerm ? line.toLowerCase().includes(searchTerm) : true;
          if (selectedFilter === 'ping') return isPing && (searchTerm ? line.toLowerCase().includes(searchTerm) : true);
          if (selectedFilter === 'pong') return isPong && (searchTerm ? line.toLowerCase().includes(searchTerm) : true);
          if (selectedFilter === 'file-transfers') return isFileTransfer && (searchTerm ? line.toLowerCase().includes(searchTerm) : true);
          if (selectedFilter === 'errors') return isError && (searchTerm ? line.toLowerCase().includes(searchTerm) : true);
          if (selectedFilter === 'connections') return isConnection && (searchTerm ? line.toLowerCase().includes(searchTerm) : true);
          if (selectedFilter === 'messages') return isMessage && (searchTerm ? line.toLowerCase().includes(searchTerm) : true);
          return true;
        });
        out.textContent = filteredLogs.join('\n');
        out.scrollTop = out.scrollHeight;
      }, 100);
      copyLogsBtn.onclick = async () => {
        try { 
          await navigator.clipboard.writeText(out.textContent); 
          log('Logs copied to clipboard'); 
        } catch (e) {
          log('Copy failed: ' + e.message);
          const t = document.createElement('textarea'); 
          t.value = out.textContent; 
          document.body.appendChild(t); 
          t.select(); 
          document.execCommand('copy'); 
          t.remove();
          log('Logs copied using fallback');
        }
      };
      downloadLogsBtn.onclick = () => {
        try {
          const blob = new Blob([logLines.join('\n')], { type: 'text/plain' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `console_logs_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 120000);
          log('Logs downloaded as file');
        } catch (e) {
          log('Download logs failed: ' + e.message);
        }
      };
      pauseLogsBtn.onclick = () => {
        isPaused = !isPaused;
        pauseLogsBtn.textContent = isPaused ? 'Resume Logs' : 'Pause Logs';
        if (!isPaused) updateLogDisplay();
        log(isPaused ? 'Logs paused' : 'Logs resumed');
      };
      searchLogs.oninput = () => {
        log('Search logs: ' + searchLogs.value);
        updateLogDisplay();
      };
      logFilter.onchange = () => {
        log('Log filter changed to: ' + logFilter.value);
        updateLogDisplay();
      };
      const es = new EventSource('/logs');
      es.onopen = () => log('SSE connection opened');
      es.onmessage = (e) => { 
        logLines.push(e.data); 
        if (logLines.length > MAX_LOG_LINES) logLines.shift();
        updateLogDisplay();
      };
      es.onerror = () => { 
        log('SSE connection error or closed');
        updateLogDisplay();
      };
    })();
  </script>
</body>
</html>
